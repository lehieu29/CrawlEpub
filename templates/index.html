{% extends "base.html" %}

{% block title %}Novel Downloader API{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download me-2"></i>Download Novel</h5>
            </div>
            <div class="card-body">
                <form id="download-form">
                    <div class="mb-3">
                        <label for="novel-url" class="form-label">Novel URL</label>
                        <input type="url" class="form-control" id="novel-url" placeholder="https://metruyencv.com/..."
                            required>
                        <div class="form-text">Enter the URL of a novel from metruyencv.com or tangthuvien.net</div>
                    </div>
                    <div class="mb-3">
                        <label for="access-token" class="form-label">Access Token (optional)</label>
                        <input type="text" class="form-control" id="access-token"
                            placeholder="Your metruyencv.com access token for premium content">
                        <div class="form-text">Only needed for premium/VIP content on metruyencv.com</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-download me-2"></i>Download Novel
                    </button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks me-2"></i>Active Downloads</h5>
            </div>
            <div class="card-body">
                <div id="active-downloads-container">
                    <div class="text-muted text-center py-3" id="no-downloads-message">
                        <i class="fas fa-info-circle me-2"></i>No active downloads
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="sidebarTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="downloads-tab" data-bs-toggle="tab"
                    data-bs-target="#active-downloads" type="button" role="tab">
                    <i class="fas fa-tasks me-1"></i>Active Downloads
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#download-logs"
                    type="button" role="tab">
                    <i class="fas fa-terminal me-1"></i>Logs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dropbox-logs-tab" data-bs-toggle="tab" data-bs-target="#dropbox-logs"
                    type="button" role="tab">
                    <i class="fab fa-dropbox me-1"></i>Dropbox Logs
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="sidebarTabContent">
            <!-- Active Downloads Tab -->
            <div class="tab-pane fade show active" id="active-downloads" role="tabpanel">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-body">
                        <div id="active-downloads-tab-container">
                            <div class="text-muted text-center py-3" id="no-downloads-tab-message">
                                <i class="fas fa-info-circle me-2"></i>No active downloads
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="download-logs" role="tabpanel">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Download Logs</h6>
                            <select id="log-filter" class="form-select form-select-sm" style="width: auto;">
                                <option value="all">All Logs</option>
                                <option value="info">Info Only</option>
                                <option value="warning">Warnings & Errors</option>
                                <option value="error">Errors Only</option>
                            </select>
                        </div>
                        <div class="log-container" id="log-container" style="height: 300px;">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-info-circle me-2"></i>Logs will appear here
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dropbox Logs Tab -->
            <div class="tab-pane fade" id="dropbox-logs" role="tabpanel">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Dropbox Logs</h6>
                            <select id="dropbox-log-filter" class="form-select form-select-sm" style="width: auto;">
                                <option value="all">All Logs</option>
                                <option value="info">Info Only</option>
                                <option value="warning">Warnings & Errors</option>
                                <option value="error">Errors Only</option>
                            </select>
                        </div>
                        <div class="log-container" id="dropbox-log-container" style="height: 300px;">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-info-circle me-2"></i>Dropbox logs will appear here
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="/downloads" class="btn btn-outline-primary">
        <i class="fas fa-book me-2"></i>View Downloaded Novels
    </a>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-info-circle me-2"></i>About Novel Downloader API</h5>
    </div>
    <div class="card-body">
        <p>This is a simple API for downloading novels from popular web novel sites. The downloaded novels are saved in
            EPUB format, which can be read on e-readers such as Kindle, Kobo, and other devices or apps.</p>

        <h6>Features:</h6>
        <ul>
            <li>Download novels from metruyencv.com and tangthuvien.net</li>
            <li>Automatic conversion to EPUB format</li>
            <li>Real-time progress tracking</li>
            <li>Cloud storage with Dropbox integration</li>
            <li>Premium content support with access tokens</li>
        </ul>

        <h6>How to use:</h6>
        <ol>
            <li>Enter the URL of the novel you want to download</li>
            <li>Enter your access token if needed for premium content</li>
            <li>Click "Download Novel" and wait for the process to complete</li>
            <li>Download your EPUB file from the provided link</li>
        </ol>
    </div>
</div>

<!-- Download Details Modal -->
<div class="modal fade" id="download-details-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="download-details-content">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading download details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Connect to Socket.IO
        const socket = io();

        // DOM elements
        const logContainer = document.getElementById('log-container');
        const logFilter = document.getElementById('log-filter');
        const dropboxLogFilter = document.getElementById('dropbox-log-filter');
        const downloadForm = document.getElementById('download-form');
        const novelUrlInput = document.getElementById('novel-url');
        const accessTokenInput = document.getElementById('access-token');
        const activeDownloadsContainer = document.getElementById('active-downloads-container');
        const noDownloadsMessage = document.getElementById('no-downloads-message');

        // Active downloads storage
        const activeDownloads = {};

        // Khôi phục dữ liệu download từ localStorage nếu có
        const storedActiveDownloads = localStorage.getItem('novel_downloader_active_downloads');
        if (storedActiveDownloads) {
            try {
                Object.assign(activeDownloads, JSON.parse(storedActiveDownloads));
            } catch (e) {
                console.error('Error parsing stored downloads:', e);
            }
        }

        // Socket.IO event handlers
        socket.on('connect', function () {
            console.log('Connected to server');
            showToast('Connected to server', 'success');
        });

        socket.on('disconnect', function () {
            console.log('Disconnected from server');
            showToast('Disconnected from server', 'danger');
        });

        socket.on('log_update', function (data) {
            addLogMessage(data.level, data.message, data.download_id);
            updateDownloadItem(data.download_id);

            // Nếu là log từ dropbox_storage, thêm vào dropbox log container
            if (data.message.includes('Dropbox') || (data.source && data.source === 'dropbox_storage')) {
                addDropboxLogMessage(data.level, data.message, data.download_id);
            }
        });

        socket.on('status_update', function (data) {
            console.log('Status update:', data);
            updateDownloadStatus(data.download_id, data.status, data.message);
        });

        socket.on('download_completed', function (data) {
            console.log('Download completed:', data);
            completeDownload(data.download_id, data.file_path, data.dropbox_url);
            showToast(`Download completed: ${data.url}`, 'success');
        });

        socket.on('download_failed', function (data) {
            console.log('Download failed:', data);
            failDownload(data.download_id, data.error);
            showToast(`Download failed: ${data.error}`, 'danger');
        });

        // Download form submission
        downloadForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const novelUrl = novelUrlInput.value.trim();
            const accessToken = accessTokenInput.value.trim();

            if (!novelUrl) {
                showToast('Please enter a novel URL', 'warning');
                return;
            }

            // Disable form during submission
            const submitButton = downloadForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            // Submit download request
            fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: novelUrl,
                    cookie: accessToken
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Download queued: ${data.download_id}`, 'success');
                        // Create download item
                        createDownloadItem(data.download_id, novelUrl);
                        // Reset form
                        novelUrlInput.value = '';
                    } else {
                        showToast(`Error: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    showToast(`Error: ${error.message}`, 'danger');
                })
                .finally(() => {
                    // Re-enable form
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-download me-2"></i>Download Novel';
                });
        });

        // Log filter change
        if (logFilter) {
            logFilter.addEventListener('change', function () {
                filterLogs(this.value);
            });
        }

        // Dropbox log filter change
        if (dropboxLogFilter) {
            dropboxLogFilter.addEventListener('change', function () {
                filterDropboxLogs(this.value);
            });
        }

        // Function to add log message to container
        function addLogMessage(level, message, downloadId) {
            const logLine = document.createElement('div');
            logLine.className = `log-line log-${level}`;
            logLine.dataset.level = level;
            logLine.dataset.downloadId = downloadId || '';

            const timestamp = new Date().toLocaleTimeString();
            logLine.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-level">[${level.toUpperCase()}]</span> ${message}`;

            logContainer.appendChild(logLine);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Apply current filter
            filterLogs(logFilter.value);

            // Hide "logs will appear here" message if present
            const noLogsMessage = logContainer.querySelector('.text-muted');
            if (noLogsMessage) {
                noLogsMessage.style.display = 'none';
            }

            // Save state
            saveAppState();
        }

        // Function to add Dropbox log message to container
        function addDropboxLogMessage(level, message, downloadId) {
            const dropboxLogContainer = document.getElementById('dropbox-log-container');
            if (!dropboxLogContainer) return;

            const logLine = document.createElement('div');
            logLine.className = `log-line log-${level}`;
            logLine.dataset.level = level;
            logLine.dataset.downloadId = downloadId || '';

            const timestamp = new Date().toLocaleTimeString();
            logLine.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-level">[${level.toUpperCase()}]</span> ${message}`;

            dropboxLogContainer.appendChild(logLine);
            dropboxLogContainer.scrollTop = dropboxLogContainer.scrollHeight;

            // Apply current filter
            if (dropboxLogFilter) {
                filterDropboxLogs(dropboxLogFilter.value);
            }

            // Hide "dropbox logs will appear here" message if present
            const noLogsMessage = dropboxLogContainer.querySelector('.text-muted');
            if (noLogsMessage) {
                noLogsMessage.style.display = 'none';
            }

            // Save state
            saveAppState();
        }

        // Function to filter logs
        function filterLogs(filterType) {
            const logLines = logContainer.querySelectorAll('.log-line');

            logLines.forEach(line => {
                const level = line.dataset.level;

                if (filterType === 'all') {
                    line.style.display = '';
                } else if (filterType === 'info' && level === 'info') {
                    line.style.display = '';
                } else if (filterType === 'warning' && (level === 'warning' || level === 'error')) {
                    line.style.display = '';
                } else if (filterType === 'error' && level === 'error') {
                    line.style.display = '';
                } else {
                    line.style.display = 'none';
                }
            });
        }

        // Function to create a new download item
        function createDownloadItem(downloadId, url) {
            // Create download item if it doesn't exist
            if (!activeDownloads[downloadId]) {
                activeDownloads[downloadId] = {
                    id: downloadId,
                    url: url,
                    status: 'queued',
                    progress: 0,
                    logs: []
                };

                // Hide "no downloads" message
                noDownloadsMessage.style.display = 'none';

                // Create DOM element
                const downloadItem = document.createElement('div');
                downloadItem.className = 'download-item';
                downloadItem.id = `download-${downloadId}`;
                downloadItem.innerHTML = `
                <div class="download-info">
                    <div class="fw-bold">${url}</div>
                    <div class="text-muted small">ID: ${downloadId}</div>
                    <div class="download-status download-status-queued">Status: Queued</div>
                    <div class="progress mt-2">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
                <div class="download-actions">
                    <button class="btn btn-sm btn-info view-details-btn" data-id="${downloadId}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            `;

                activeDownloadsContainer.appendChild(downloadItem);

                // Add event listener for details button
                downloadItem.querySelector('.view-details-btn').addEventListener('click', function () {
                    showDownloadDetails(downloadId);
                });
            }

            // Save state
            saveAppState();
        }

        // Function to update download item status
        function updateDownloadStatus(downloadId, status, message) {
            if (activeDownloads[downloadId]) {
                activeDownloads[downloadId].status = status;

                const downloadItem = document.getElementById(`download-${downloadId}`);
                if (downloadItem) {
                    const statusElement = downloadItem.querySelector('.download-status');
                    statusElement.className = `download-status download-status-${status}`;
                    statusElement.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;

                    // Update progress based on status
                    let progress = 0;
                    if (status === 'queued') progress = 0;
                    else if (status === 'in_progress') progress = 50;
                    else if (status === 'completed') progress = 100;
                    else if (status === 'failed') progress = 100;

                    const progressBar = downloadItem.querySelector('.progress-bar');
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress);
                    progressBar.textContent = `${progress}%`;

                    if (status === 'completed') {
                        progressBar.classList.add('bg-success');
                    } else if (status === 'failed') {
                        progressBar.classList.add('bg-danger');
                    }
                }
            }

            // Save state
            saveAppState();
        }

        // Function to mark download as completed
        function completeDownload(downloadId, filePath, dropboxUrl) {
            updateDownloadStatus(downloadId, 'completed');

            const downloadItem = document.getElementById(`download-${downloadId}`);
            if (downloadItem) {
                const actionsDiv = downloadItem.querySelector('.download-actions');

                // Clear existing buttons
                actionsDiv.innerHTML = '';

                // Add View Downloads button
                const viewDownloadsBtn = document.createElement('a');
                viewDownloadsBtn.href = '/downloads';
                viewDownloadsBtn.className = 'btn btn-sm btn-primary';
                viewDownloadsBtn.innerHTML = '<i class="fas fa-book me-1"></i>';
                viewDownloadsBtn.title = 'View Downloads';
                actionsDiv.appendChild(viewDownloadsBtn);

                // Add dropbox button if available
                if (dropboxUrl) {
                    const dropboxBtn = document.createElement('a');
                    dropboxBtn.href = dropboxUrl;
                    dropboxBtn.className = 'btn btn-sm btn-success ms-1';
                    dropboxBtn.innerHTML = '<i class="fas fa-cloud-download-alt me-1"></i>';
                    dropboxBtn.title = 'Download from Dropbox';
                    dropboxBtn.target = '_blank';
                    actionsDiv.appendChild(dropboxBtn);
                } else {
                    // If no dropbox URL, add direct download button
                    const directDownloadBtn = document.createElement('a');
                    directDownloadBtn.href = `/api/download_direct/${downloadId}`;
                    directDownloadBtn.className = 'btn btn-sm btn-success ms-1';
                    directDownloadBtn.innerHTML = '<i class="fas fa-download me-1"></i>';
                    directDownloadBtn.title = 'Download directly';
                    actionsDiv.appendChild(directDownloadBtn);
                }

                // Add View Details button
                const viewDetailsBtn = document.createElement('button');
                viewDetailsBtn.className = 'btn btn-sm btn-info ms-1';
                viewDetailsBtn.innerHTML = '<i class="fas fa-eye me-1"></i>';
                viewDetailsBtn.title = 'View Details';
                viewDetailsBtn.setAttribute('data-id', downloadId);
                viewDetailsBtn.addEventListener('click', function () {
                    showDownloadDetails(downloadId);
                });
                actionsDiv.appendChild(viewDetailsBtn);
            }

            // Save state
            saveAppState();
        }

        // Function to mark download as failed
        function failDownload(downloadId, error) {
            updateDownloadStatus(downloadId, 'failed');

            const downloadItem = document.getElementById(`download-${downloadId}`);
            if (downloadItem) {
                const infoDiv = downloadItem.querySelector('.download-info');

                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger small mt-1';
                errorDiv.textContent = `Error: ${error}`;
                infoDiv.appendChild(errorDiv);
            }

            // Save state
            saveAppState();
        }

        // Function to update download item based on new logs
        function updateDownloadItem(downloadId) {
            if (!downloadId) return;

            // Make sure download item exists
            if (!activeDownloads[downloadId]) {
                // Create a new item with unknown URL
                createDownloadItem(downloadId, 'Unknown URL');
            }

            // Count chapters based on log entries
            const chapterRegex = /Đã tải chương (\d+)/;
            const logLines = logContainer.querySelectorAll(`.log-line[data-download-id="${downloadId}"]`);
            let maxChapter = 0;

            logLines.forEach(line => {
                const match = line.textContent.match(chapterRegex);
                if (match && parseInt(match[1]) > maxChapter) {
                    maxChapter = parseInt(match[1]);
                }
            });

            // Update progress if chapters are found
            if (maxChapter > 0) {
                const downloadItem = document.getElementById(`download-${downloadId}`);
                if (downloadItem) {
                    const progressBar = downloadItem.querySelector('.progress-bar');
                    // We don't know total chapters, so just show the current number
                    progressBar.textContent = `${maxChapter} chương`;
                }
            }

            // Save state
            saveAppState();
        }

        // Function to show download details modal
        function showDownloadDetails(downloadId) {
            const modal = new bootstrap.Modal(document.getElementById('download-details-modal'));
            const contentDiv = document.getElementById('download-details-content');

            // Show loading state
            contentDiv.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading download details...</p>
                </div>
            `;

            modal.show();

            // Fetch download status
            fetch(`/api/status/${downloadId}?logs=100`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Format status and logs
                        const status = data.status;
                        const logs = data.logs || [];

                        let statusClass = '';
                        if (status.status === 'completed') statusClass = 'text-success';
                        else if (status.status === 'failed') statusClass = 'text-danger';
                        else if (status.status === 'in_progress') statusClass = 'text-primary';
                        else statusClass = 'text-secondary';

                        // Create content
                        let content = `
                            <h5>Download Information</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th width="120">ID:</th>
                                    <td>${downloadId}</td>
                                </tr>
                                <tr>
                                    <th>URL:</th>
                                    <td>${status.url || 'Unknown'}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td class="${statusClass}">${status.status.charAt(0).toUpperCase() + status.status.slice(1)}</td>
                                </tr>
                            `;

                        if (status.submit_time) {
                            content += `
                                <tr>
                                    <th>Submitted:</th>
                                    <td>${new Date(status.submit_time * 1000).toLocaleString()}</td>
                                </tr>
                            `;
                        }

                        if (status.start_time) {
                            content += `
                                <tr>
                                    <th>Started:</th>
                                    <td>${new Date(status.start_time * 1000).toLocaleString()}</td>
                                </tr>
                            `;
                        }

                        if (status.end_time) {
                            content += `
                                <tr>
                                    <th>Finished:</th>
                                    <td>${new Date(status.end_time * 1000).toLocaleString()}</td>
                                </tr>
                            `;

                            // Calculate duration
                            const duration = Math.round((status.end_time - status.start_time) / 60);
                            content += `
                                <tr>
                                    <th>Duration:</th>
                                    <td>${duration} minutes</td>
                                </tr>
                            `;
                        }

                        if (status.file_path) {
                            content += `
                                <tr>
                                    <th>File path:</th>
                                    <td>${status.file_path}</td>
                                </tr>
                            `;
                        }

                        if (status.dropbox_url) {
                            content += `
                                <tr>
                                    <th>Download:</th>
                                    <td>
                                        <a href="${status.dropbox_url}" target="_blank" class="btn btn-sm btn-success">
                                            <i class="fas fa-cloud-download-alt me-1"></i>Download from Dropbox
                                        </a>
                                    </td>
                                </tr>
                            `;
                        }

                        content += `
                            </table>

                            <h5 class="mt-4">Download Logs</h5>
                            <div class="log-container" style="max-height: 300px; overflow-y: auto;">
                        `;

                        if (logs.length > 0) {
                            content += `<div class="small">`;
                            logs.forEach(log => {
                                let logClass = '';
                                if (log.includes('[INFO]')) logClass = 'text-primary';
                                else if (log.includes('[WARNING]')) logClass = 'text-warning';
                                else if (log.includes('[ERROR]')) logClass = 'text-danger';

                                content += `<div class="${logClass}">${log}</div>`;
                            });
                            content += `</div>`;
                        } else {
                            content += `<p class="text-muted">No logs available</p>`;
                        }

                        content += `</div>`;

                        contentDiv.innerHTML = content;
                    } else {
                        contentDiv.innerHTML = `
                            <div class="alert alert-danger">
                                Error: ${data.error || 'Could not retrieve download details'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `
                        <div class="alert alert-danger">
                            Error: ${error.message || 'Could not retrieve download details'}
                        </div>
                    `;
                });
        }

        // Khôi phục trạng thái ban đầu
        restoreAppState();
    });
</script>
{% endblock %}